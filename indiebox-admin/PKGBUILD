pkgname=$(basename $(pwd))
pkgver=0.60
pkgrel=1
pkgdesc="Indie Box administration infrastructure and tools"
arch=('any')
url="http://indiebox.net/"
license=('GPL')
groups=()
depends=('cronie' 'ntp' 'btrfs-progs' 'sudo' 'perl' 'perl-lchown' 'perl-json' 'perl-log-log4perl' 'mariadb' 'perl-dbi' 'perl-dbd-mysql' 'perl-archive-zip' 'apache' 'mod_wsgi2' )
backup=(
    'etc/indiebox/config.json'
    'etc/indiebox/log-admin.conf'
    'etc/indiebox/log-user.conf'
    'etc/httpd/indiebox/defaults.conf'
    'etc/httpd/indiebox/defaultsite.conf'
    'etc/httpd/indiebox/errors.conf'
    'etc/httpd/indiebox/logging.conf'
    'etc/httpd/indiebox/usersettings.conf'
)
source=()
options=('!strip')
install=install

package() {
# Code
    mkdir -p $pkgdir/usr/bin
    install -m755 $startdir/bin/indiebox-admin $pkgdir/usr/bin/

    for d in AppConfigurationItems BackupManagers Commands Databases Roles TemplateProcessor; do
        mkdir -p $pkgdir/usr/lib/perl5/vendor_perl/IndieBox/$d
        for f in $startdir/vendor_perl/IndieBox/$d/*.pm; do
            install -m755 $f $pkgdir/usr/lib/perl5/vendor_perl/IndieBox/$d/
        done
    done
    for f in $startdir/vendor_perl/IndieBox/*.pm; do
        install -m755 $f $pkgdir/usr/lib/perl5/vendor_perl/IndieBox/
    done

    mkdir -p $pkgdir/usr/share/indiebox/cgi-bin
    install -m755 $startdir/cgi-bin/show-apps.pl $pkgdir/usr/share/indiebox/cgi-bin/

    mkdir -p $pkgdir/usr/share/$pkgname/bin
    install -m755 $startdir/bin/{initialize,apachectl} $pkgdir/usr/share/$pkgname/bin/
    
    # (hopefully) temporary patch to Perl's Archive::Zip
    mkdir -p $pkgdir/usr/lib/perl5/vendor_perl/Archive/Zip
    install $startdir/vendor_perl/Archive/Zip/Member.pm $pkgdir/usr/lib/perl5/vendor_perl/Archive/Zip/

# Config files
    mkdir -p $pkgdir/etc/indiebox/ssl

    install -m644 $startdir/etc/indiebox/config.json           $pkgdir/etc/indiebox/
    install -m644 $startdir/etc/indiebox/log-{admin,user}.conf $pkgdir/etc/indiebox/

# Site files and AppConfiguration parameter files
    mkdir -p $pkgdir/var/lib/indiebox/sites
    mkdir -p $pkgdir/var/lib/indiebox/appconfigpars

# Manifest files
    mkdir -p $pkgdir/var/lib/indiebox/manifests

# Backup files
    mkdir -p $pkgdir/var/lib/indiebox/backups/admin

# Web server config files
    mkdir -p $pkgdir/etc/httpd/conf
    mkdir -p $pkgdir/etc/httpd/indiebox/{appconfigs,mods-available,mods-enabled,sites,ssl}
    install -m644 $startdir/etc/httpd/conf/httpd-indiebox.conf $pkgdir/etc/httpd/conf/
    for f in $startdir/etc/httpd/indiebox/*.conf; do
        install -m644 $f $pkgdir/etc/httpd/indiebox/
    done
    for f in $startdir/etc/httpd/indiebox/mods-available/*.load; do
        install -m644 $f $pkgdir/etc/httpd/indiebox/mods-available/
    done

# Web server content files
    mkdir -p $pkgdir/srv/http/_common/{css,images}
    install -m644 $startdir/www/_common/css/*.css $pkgdir/srv/http/_common/css/
    install -m644 $startdir/www/_common/images/*.png $pkgdir/srv/http/_common/images/

    mkdir -p $pkgdir/srv/http/_appicons/default
    install -m644 $startdir/www/_appicons/default/{72x72,144x144}.png $pkgdir/srv/http/_appicons/default/

    mkdir -p $pkgdir/srv/http/placeholders/maintenance
    mkdir -p $pkgdir/srv/http/placeholders/nosuchsite

    for d in maintenance nosuchsite; do
        for f in $startdir/www/placeholders/$d/*.html; do
            install -m644 $f $pkgdir/srv/http/placeholders/$d/
        done
    done

    mkdir -p $pkgdir/srv/http/sites
    mkdir -p $pkgdir/srv/http/wellknown

# CGI files
    mkdir -p $pkgdir/usr/share/indiebox/cgi-bin
    install -m755 $startdir/cgi-bin/{show-apps,render-appicon}.pl $pkgdir/usr/share/indiebox/cgi-bin/

# Tomcat
    mkdir -p -m 775 $pkgdir/etc/tomcat7
    mkdir -p $pkgdir/etc/tomcat7/indiebox/sites-apps
    install -m644 $startdir/etc/tomcat7/server-indiebox.xml.tmpl $pkgdir/etc/tomcat7/
    mkdir -p -m 775 $pkgdir/var/lib/tomcat7
    mkdir -p $pkgdir/var/lib/tomcat7/sites

# Mysql
    mkdir -p -m 755 $pkgdir/etc/mysql
    install -m644 $startdir/etc/mysql/mysql-indiebox.cnf $pkgdir/etc/mysql/

# Systemd
    mkdir -p -m 755 $pkgdir/usr/lib/systemd/system/
    install -m 644 $startdir/systemd/indiebox-*.service $pkgdir/usr/lib/systemd/system/

# Other config files
    mkdir -p $pkgdir/etc/php/conf.d
    install -m644 $startdir/etc/php/conf.d/{session.save_path,timezone}.ini $pkgdir/etc/php/conf.d/
}
